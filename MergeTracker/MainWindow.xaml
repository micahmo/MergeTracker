<Window x:Class="MergeTracker.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:MergeTracker"
        xmlns:c="clr-namespace:CalcBinding;assembly=CalcBinding"
        xmlns:i="http://schemas.microsoft.com/expression/2010/interactivity"
        mc:Ignorable="d"
        Title="Merge Tracker" Height="800" Width="1500"

        Closing="Window_Closing">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="40"/>
            <RowDefinition/>
        </Grid.RowDefinitions>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0" Command="{Binding Commands.CreateMergeItemCommand}" Content="New Merge Item" Margin="5" Padding="5"/>

            <TextBlock Grid.Column="1" Text="Filter by work item number:" Margin="5" Padding="5"/>

            <TextBox Grid.Column="2" Text="{Binding RootConfiguration.BugNumberFilter, UpdateSourceTrigger=PropertyChanged, Delay=500}" Margin="5" Padding="5"/>

            <TextBlock Grid.Column="3" Text="Filter by changeset number:" Margin="5" Padding="5"/>

            <TextBox Grid.Column="4" Text="{Binding RootConfiguration.ChangesetNumberFilter, UpdateSourceTrigger=PropertyChanged, Delay=500}" Margin="5" Padding="5"/>

            <TextBlock Grid.Column="5" Text="Filter by target branch:" Margin="5" Padding="5"/>

            <TextBox Grid.Column="6" Text="{Binding RootConfiguration.TargetBranchFilter, UpdateSourceTrigger=PropertyChanged, Delay=500}" Margin="5" Padding="5"/>

            <TextBlock Grid.Column="7" Text="Filter by not completed:" Margin="5" Padding="5"/>

            <CheckBox Grid.Column="8" IsChecked="{Binding RootConfiguration.NotCompletedFilter}" Margin="5" Padding="5" VerticalAlignment="Center"/>

            <Button Grid.Column="9" Content="Reapply filters" Margin="5" Padding="5" VerticalAlignment="Center"
                    Command="{Binding Commands.FilterCommand}"/>

            <Button Grid.Column="10" Content="Clear filters" Margin="5" Padding="5" VerticalAlignment="Center"
                    Command="{Binding Commands.ClearFiltersCommand}"/>
        </Grid>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="0,5,0,0">
            <ItemsControl ItemsSource="{Binding RootConfiguration.MergeItems}" Margin="5" IsTabStop="False">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <local:MergeItemGrid Visibility="{c:Binding '!IsFiltered', FalseToVisibility=Collapsed}">
                            <local:MergeItemGrid.ContextMenu>
                                <ContextMenu x:Name="MergeItemContextMenu">
                                    <MenuItem Header="Work Item Server" IsCheckable="False" ItemsSource="{Binding WorkItemServers}" IsEnabled="{c:Binding 'WorkItemServer != null'}">
                                        <MenuItem.ItemContainerStyle>
                                            <Style TargetType="MenuItem">
                                                <Setter Property="IsChecked" Value="{Binding IsSelected}"/>
                                                <Setter Property="Command" Value="{Binding Command}"/>
                                            </Style>
                                        </MenuItem.ItemContainerStyle>
                                    </MenuItem>
                                    <MenuItem Header="Source Control Server" IsCheckable="False" ItemsSource="{Binding SourceControlServers}" IsEnabled="{c:Binding 'SourceControlServer != null'}">
                                        <MenuItem.ItemContainerStyle>
                                            <Style TargetType="MenuItem">
                                                <Setter Property="IsChecked" Value="{Binding IsSelected}"/>
                                                <Setter Property="Command" Value="{Binding Command}"/>
                                            </Style>
                                        </MenuItem.ItemContainerStyle>
                                    </MenuItem>
                                </ContextMenu>
                            </local:MergeItemGrid.ContextMenu>

                            <local:MergeItemGrid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </local:MergeItemGrid.ColumnDefinitions>

                            <local:MergeItemGrid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition/>
                                <RowDefinition Height="20"/>
                                <RowDefinition Height="15"/>
                                <RowDefinition Height="20"/>
                            </local:MergeItemGrid.RowDefinitions>

                            <TextBox Grid.Column="0" Grid.Row="0" Margin="5" Padding="5" Text="{Binding Name}" FontWeight="Medium"
                                     ToolTip="{Binding Name}"/>

                            <TextBlock Grid.Column="1" Grid.Row="0" Margin="5" Padding="5" Text="!!" FontSize="15"
                                       ToolTip="{Binding LastError}" Visibility="{c:Binding HasLastError, FalseToVisibility=Collapsed}"/>

                            <Button Grid.Column="3" Grid.Row="0" Margin="5" Padding="5,0,5,0" Content="New Merge Target"
                                    Command="{Binding Commands.CreateMergeTargetCommand}"/>

                            <Button Grid.Column="4" Grid.Row="0" Margin="5" Padding="5,0,5,0" Content="Delete"
                                    Command="{Binding Commands.DeleteCommand}"/>

                            <DataGrid x:Name="DataGrid" Grid.Column="0" Grid.ColumnSpan="5" Grid.Row="1" Margin="5" ItemsSource="{Binding MergeTargets}" AutoGenerateColumns="False"
                                      GridLinesVisibility="None" HeadersVisibility="Column" BorderThickness="0" CanUserAddRows="False">
                                <i:Interaction.Behaviors>
                                    <local:IgnoreMouseWheelBehavior/>
                                </i:Interaction.Behaviors>

                                <DataGrid.Resources>
                                    <Style BasedOn="{StaticResource {x:Type DataGridColumnHeader}}" TargetType="{x:Type DataGridColumnHeader}">
                                        <Setter Property="Background" Value="Transparent" />
                                        <Setter Property="Margin" Value="5" />
                                    </Style>

                                    <Style TargetType="{x:Type DataGridCell}">
                                        <Setter Property="IsTabStop" Value="False"/>
                                        <Style.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter Property="Background" Value="{x:Null}" />
                                                <Setter Property="BorderBrush" Value="{x:Null}" />
                                            </Trigger>

                                            <DataTrigger Binding="{Binding IsCompleted}" Value="True">
                                                <Setter Property="Background" Value="LightGreen" />
                                                <Setter Property="BorderBrush" Value="LightGreen" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsCompleted}" Value="False">
                                                <Setter Property="Background" Value="Pink" />
                                                <Setter Property="BorderBrush" Value="Pink" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>

                                </DataGrid.Resources>

                                <DataGrid.Columns>

                                    <DataGridTemplateColumn Header="Completed" Width="Auto">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <CheckBox IsChecked="{Binding IsCompleted, UpdateSourceTrigger=PropertyChanged}" Margin="5" HorizontalAlignment="Center"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTemplateColumn Header="Original" Width="Auto">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <RadioButton IsChecked="{Binding IsOriginal, UpdateSourceTrigger=PropertyChanged}" Margin="5" HorizontalAlignment="Center"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTemplateColumn Header="Work Item Number" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <TextBox Grid.Column="0" Text="{Binding BugNumber, UpdateSourceTrigger=PropertyChanged}" Margin="5,5,0,5"
                                                             ToolTip="{Binding BugNumber}"/>
                                                    <Button Grid.Column="1" Width="20" Margin="0,5,0,5" HorizontalAlignment="Right" Content="❐"
                                                            Command="{Binding DataContext.Commands.CopyBugNumberCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                            CommandParameter="{Binding ElementName=DataGrid}"
                                                            ToolTip="Copy work item number to clipboard"/>
                                                    <Button Grid.Column="2" Width="20" Margin="0,5,5,5" HorizontalAlignment="Right" Content="◥"
                                                            Command="{Binding DataContext.Commands.OpenBugCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                            CommandParameter="{Binding ElementName=DataGrid}"
                                                            ToolTip="Open work item in TFS web"/>
                                                </Grid>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTemplateColumn Header="Target Branch" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBox Text="{Binding TargetBranch, UpdateSourceTrigger=PropertyChanged}" Margin="5"
                                                         ToolTip="{Binding TargetBranch}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTemplateColumn Header="Changeset(s)" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <TextBox Text="{Binding Changeset, UpdateSourceTrigger=PropertyChanged}" Margin="5,5,0,5"
                                                             ToolTip="{Binding Changeset}"/>
                                                    <Button Grid.Column="1" Width="20" Margin="0,5,5,5" HorizontalAlignment="Right" Content="◥"
                                                            Command="{Binding DataContext.Commands.OpenChangesetCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                            CommandParameter="{Binding ElementName=DataGrid}"
                                                            ToolTip="Open changeset(s) in TFS web"/>
                                                </Grid>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTemplateColumn Header="Notes" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBox Text="{Binding Notes, UpdateSourceTrigger=PropertyChanged}" Margin="5"
                                                         ToolTip="{Binding Notes}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTemplateColumn Header="Generate Check-in Message" Width="Auto">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Content="Generate Check-in Message" Margin="5" Padding="5,0,5,0"
                                                        Command="{Binding DataContext.Commands.GenerateMessageCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                        CommandParameter="{Binding ElementName=DataGrid}"
                                                        ToolTip="Generates a check-in message containing the original work item number and branch info and the target branch.&#x0a;Copies the message to the clipboard."/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTemplateColumn Header="Delete" Width="Auto">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Content="Delete" Margin="5" Padding="5,0,5,0"
                                                        Command="{Binding DataContext.Commands.DeleteMergeTargetCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                        CommandParameter="{Binding ElementName=DataGrid}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                    <DataGridTemplateColumn Header="Menu" Width="Auto">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Content="▼" Margin="5" Padding="5,0,5,0"
                                                        Command="{Binding DataContext.Commands.ShowMergeItemContextMenuCommand, RelativeSource={RelativeSource AncestorType=local:MainWindow}}"
                                                        CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=local:MergeItemGrid}}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>

                                </DataGrid.Columns>
                            </DataGrid>

                            <Canvas Grid.Column="0" Grid.ColumnSpan="5" Grid.Row="3" Background="LightGray" Margin="5"/>
                        </local:MergeItemGrid>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <GridSplitter Grid.Row="1" VerticalAlignment="Top" HorizontalAlignment="Stretch" Background="DarkGray" Height="5" IsEnabled="False" />
    </Grid>
</Window>
